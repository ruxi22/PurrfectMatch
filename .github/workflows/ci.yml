name: CI Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Checkout code
      - name: Checkout Repository
        uses: actions/checkout@v3

      # Java 17
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: "17"
          distribution: "temurin"

      # ---------- BACKEND MICROSERVICES ----------
      # Build Adoption Service
      - name: Build Adoption Service
        run: mvn -B -DskipTests clean package --file adoption-service/pom.xml

      # Build Notification Service
      - name: Build Notification Service
        run: mvn -B -DskipTests clean package --file notification-service/pom.xml

      # Build Pet Service
      - name: Build Pet Service
        run: mvn -B -DskipTests clean package --file pet-service/pom.xml

      # Build Auth Service
      - name: Build Auth Service
        run: mvn -B -DskipTests clean package --file auth-service/pom.xml

      # Build API Gateway
      - name: Build API Gateway
        run: mvn -B -DskipTests clean package --file api-gateway/pom.xml

      # ---------- DOCKER BUILDS ----------
      - name: Build Docker Images
        run: |
          docker build -t adoption-service ./adoption-service
          docker build -t notification-service ./notification-service
          docker build -t pet-service ./pet-service
          docker build -t auth-service ./auth-service
          docker build -t api-gateway ./api-gateway

      # ---------- VALIDATE DOCKER COMPOSE ----------
      - name: Validate Docker Compose
        run: docker compose config
