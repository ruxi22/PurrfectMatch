name: PurrfectMatch CI Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest

    steps:
      # ---------- CHECKOUT ----------
      - name: Checkout Code
        uses: actions/checkout@v4

      # ---------- JDK ----------
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven

      # ---------- BUILD + TEST SERVICES ----------
      - name: Build Auth Service
        run: mvn -B clean package -f auth-service/pom.xml

      - name: Build Pet Service
        run: mvn -B clean package -f pet-service/pom.xml

      - name: Build Adoption Service
        run: mvn -B clean package -f adoption-service/pom.xml

      - name: Build Notification Service
        run: mvn -B clean package -f notification-service/pom.xml

      - name: Build API Gateway
        run: mvn -B clean package -f api-gateway/pom.xml

      - name: Build Frontend Service
        run: mvn -B clean package -f frontend-service/pom.xml

      # ---------- DOCKER BUILD ----------
      - name: Build Docker Images
        run: docker compose build

      # ---------- DEPLOYMENT SIMULATION ----------
      - name: Simulate Deployment (Start & Verify)
        run: |
          echo "Starting Docker Environment..."
          docker compose up -d

          echo "Waiting 60 seconds for initialization..."
          sleep 60

          echo "Checking running containers..."
          docker ps -a

          echo "Checking API Gateway health..."
          curl --fail http://localhost:8090/actuator/health || exit 1

          echo "All good. Shutting down environment..."
          docker compose down
